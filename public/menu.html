<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu - Chai-Pani</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="app-container">
        <nav class="sidebar">
            <div class="logo">Chai-Pani</div>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="menu.html" class="active">Menu</a></li>
                <li><a href="tables.html">Tables</a></li>
                <li><a href="orders.html">Orders</a></li>
                <li><a href="kitchen.html">Kitchen (KOT)</a></li>
                <li><a href="inventory.html">Inventory</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="#" onclick="logout()">Logout</a></li>
            </ul>
        </nav>

        <main class="content">
            <div class="flex justify-between items-center mb-2">
                <h1>Menu Items</h1>
                <button class="btn btn-primary" onclick="openModal()" data-role="admin,manager">Add Item</button>
            </div>

            <div class="grid grid-3" id="menu-grid">
                <!-- Menu items will be loaded here -->
            </div>
        </main>
    </div>

    <!-- Add/Edit Modal -->
    <div id="item-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2 id="modal-title" class="mb-2">Add Menu Item</h2>
            <form id="item-form">
                <input type="hidden" id="item-id">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="item-name" required>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="item-category" required>
                        <option value="Starters">Starters</option>
                        <option value="Main Course">Main Course</option>
                        <option value="Breads">Breads</option>
                        <option value="Beverages">Beverages</option>
                        <option value="Desserts">Desserts</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Price (â‚¹)</label>
                    <input type="number" id="item-price" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="item-desc" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="item-available" style="width: auto;"> Available
                    </label>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Save</button>
            </form>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadMenu();
        });

        async function loadMenu() {
            const response = await fetchAPI('/menu/');
            if (!response) return;

            const items = await response.json();
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = '';

            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <h3 style="color: var(--primary-color);">${item.name}</h3>
                        <span class="badge ${item.available ? 'badge-success' : 'badge-danger'}">
                            ${item.available ? 'Available' : 'Unavailable'}
                        </span>
                    </div>
                    <p class="text-muted" style="font-size: 0.9rem;">${item.category}</p>
                    <p class="mt-1">${item.description || ''}</p>
                    <h4 class="mt-1">${formatCurrency(item.price)}</h4>
                    
                    <div class="mt-2 flex gap-1" data-role="admin,manager">
                        <button class="btn btn-outline" style="flex: 1; padding: 5px;" onclick='editItem(${JSON.stringify(item)})'>Edit</button>
                        <button class="btn btn-danger" style="flex: 1; padding: 5px;" onclick="deleteItem(${item.id})">Delete</button>
                    </div>
                `;
                grid.appendChild(card);
            });

            updateUIForUser();
        }

        function openModal(item = null) {
            const modal = document.getElementById('item-modal');
            const title = document.getElementById('modal-title');
            const form = document.getElementById('item-form');

            if (item) {
                title.textContent = 'Edit Menu Item';
                document.getElementById('item-id').value = item.id;
                document.getElementById('item-name').value = item.name;
                document.getElementById('item-category').value = item.category;
                document.getElementById('item-price').value = item.price;
                document.getElementById('item-desc').value = item.description || '';
                document.getElementById('item-available').checked = item.available;
            } else {
                title.textContent = 'Add Menu Item';
                form.reset();
                document.getElementById('item-id').value = '';
                document.getElementById('item-available').checked = true;
            }

            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('item-modal').classList.remove('active');
        }

        function editItem(item) {
            openModal(item);
        }

        async function deleteItem(id) {
            if (!confirm('Are you sure you want to delete this item?')) return;

            const response = await fetchAPI(`/menu/${id}`, { method: 'DELETE' });
            if (response && response.ok) {
                loadMenu();
            }
        }

        document.getElementById('item-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('item-id').value;
            const data = {
                name: document.getElementById('item-name').value,
                category: document.getElementById('item-category').value,
                price: parseFloat(document.getElementById('item-price').value),
                description: document.getElementById('item-desc').value,
                available: document.getElementById('item-available').checked
            };

            let response;
            if (id) {
                response = await fetchAPI(`/menu/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            } else {
                response = await fetchAPI('/menu/', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            }

            if (response && response.ok) {
                closeModal();
                loadMenu();
            } else {
                alert('Failed to save item');
            }
        });
    </script>
</body>

</html>